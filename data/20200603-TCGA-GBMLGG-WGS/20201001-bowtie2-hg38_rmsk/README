
./bowtie2-hg38_rmsk.bash



	0x4	UNMAP         .. segment unmapped
	0x8	MUNMAP        .. next segment in the template unmapped


samtools view /scratch/1968740.cclc01.som.ucsf.edu/02-2483-01A-01D-1494.bowtie2.hg38_rmsk.bam | awk '( ( and($2,4) && !and($2,8) ) || ( !and($2,4) && and($2,8) ) ){print}'


samtools view /scratch/1968740.cclc01.som.ucsf.edu/02-2483-01A-01D-1494.bowtie2.hg38_rmsk.bam | awk '( and($2,4) && !and($2,8) ){print}'

samtools view /scratch/1968740.cclc01.som.ucsf.edu/02-2483-01A-01D-1494.bowtie2.hg38_rmsk.bam | awk -F"\t" '( and($2,4) && !and($2,8) ){print ">"$1"-"$3; print $10}' 

for bam in out/*bam ; do
echo $bam
fasta=${bam%.bam}.fa.gz
echo $fasta
samtools view $bam | awk -F"\t" '( and($2,4) && !and($2,8) ){print ">"$1"-"$3; print $10}' | gzip > ${fasta}
done


	dsk.bash \
		-nb-cores ${PBS_NUM_PPN:-1} -kmer-size ${k} -abundance-min 0 \
		-max-memory $[vmem/2]000 -file ${unmapped_fasta} -out ${outbase}.h5

	dsk2ascii.bash -nb-cores ${PBS_NUM_PPN:-1} -file ${h5} -out ${outbase}.txt.gz


k=31
for fasta in out/*fa.gz; do
#echo $fasta
outbase=${fasta%.fa.gz}.${k}.dsk
#echo $outbase
h5="${outbase}.h5"
echo "dsk.bash -max-memory 100000 -nb-cores 16 -kmer-size ${k} -abundance-min 0 -file ${fasta} -out ${outbase}.h5 > ${outbase}.h5.out 2> ${outbase}.h5.err"
done | parallel &


for h5 in out/*.${k}.dsk.h5; do
outbase=${h5%.h5}2ascii
echo "dsk2ascii.bash -nb-cores 16 -file ${h5} -out ${outbase}.txt.gz > ${outbase}.out 2> ${outbase}.err"
done | parallel &


for f in out/*.dsk2ascii.txt.gz ; do
echo $f
base=${f%.txt.gz}
zcat $f | wc -l > ${base}.wc-l &
zcat $f | awk '($2>1)' | wc -l > ${base}.gt1.wc-l &
zcat $f | awk '($2>2)' | wc -l > ${base}.gt2.wc-l &
zcat $f | awk '($2>3)' | wc -l > ${base}.gt3.wc-l &
done


for f in out/*.${k}.dsk2ascii.txt.gz ; do
echo $f
base=${f%.txt.gz}
zcat $f | awk '($2>1)' | gzip > ${base}.gt1.txt.gz &
done


merge_mer_counts.py -o merged.bowtie2.hg38_rmsk.${k}.dsk2ascii.csv.gz out/*.bowtie2.hg38_rmsk.${k}.dsk2ascii.txt.gz &

merge_mer_counts.py -o merged.bowtie2.hg38_rmsk.${k}.dsk2ascii.gt1.csv.gz out/*.bowtie2.hg38_rmsk.${k}.dsk2ascii.gt1.txt.gz &




nohup zcat out/02-248*.21.dsk2ascii.txt.gz | awk '{print $1}' | sort | uniq | gzip > k21.txt.gz &

for f in out/02-248*.21.dsk2ascii.txt.gz ; do
base=${f%.txt.gz}
nohup zcat $f | sort | gzip > ${base}.sorted.txt.gz &
done



date=$( date "+%Y%m%d%H%M%S" )
for f in $PWD/out/02-248*.21.dsk2ascii.txt.gz ; do
jobbase=$( basename $f .bowtie2.hg38_rmsk.21.dsk2ascii.txt.gz )
outbase=${f%.txt.gz}
qsub -N ${jobbase}.uslt.21 \
  -l feature=nocommunal \
  -l gres=scratch:50 \
  -l nodes=1:ppn=8 -l vmem=16gb \
  -j oe -o ${outbase}.${date}.out.txt \
  ~/.local/bin/dsk_ascii_split_scratch.bash \
  -F "-k 21 -u 15 -outbase ${outbase}"
done

