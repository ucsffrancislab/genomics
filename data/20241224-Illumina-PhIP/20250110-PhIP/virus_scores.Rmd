#!/usr/bin/env Rscript

args <- commandArgs()
fname <- normalizePath(sub("--file=", "", args[grepl("--file=", args)]))
thisfile <- readLines(fname)
newfname <- paste0(tempdir(), "/", basename(fname))
writeLines(thisfile[-1:-which(thisfile == "q(\"no\")")], newfname)


#	argparse (as opposed to optparse) allow the "append" action and the "required" option.
library("argparse")
args=commandArgs()
scriptname=sub("--file=", "", args[grepl("--file=", args)])
parser <- ArgumentParser(description=scriptname)

parser$add_argument("-d", "--dir", type="character", required=TRUE, action="append",
        help="dir to compare (use multiple times for each)", metavar="group")
parser$add_argument("-o", "--output", type="character", default="virus_scores",
        help="output base [default=%(default)s]", metavar="file base")

opt <- parser$parse_args()

#noext=fs::path_ext_remove(fname)
#rmarkdown::render(newfname, output_dir = dirname(fname), output_file = paste0(noext,'.html') )
#rmarkdown::render(newfname, output_dir = dirname(fname), output_file = paste0(opt$output,'.html') )
rmarkdown::render(newfname, output_dir = dirname(opt$output), output_file = paste0(opt$output,'.html') )

q("no")

---
title: "Executable Rmarkdown script"
author: "JW"
date: "2025-01-10"
output: html_document
---



```{r args}
args
```

```{r optargs}
opt
```

```{r setup, include=FALSE}
library(reticulate)
use_python("/usr/bin/python3")
```

```{python}
import pandas as pd
import matplotlib.pyplot as plt
```

```{python read csvs}
plates=[]
for p in r.opt['dir']:
	plate = pd.read_csv(p+"/virus_scores.10.csv", index_col=0)
	plates.append(plate)
```

```{python concat csvs}
df = pd.concat(plates)
df.shape
```

```{python}
df = df[df['type']=='pemphigus serum']
df.drop(columns=['id','type'],inplace=True)
df = df.reset_index().set_index(['subject','group']).sort_index().reset_index().set_index('subject')
df.fillna(0,inplace=True)
```

```{python}
df.drop(columns='group').max().max()
#np.float64(68.0)
```

```{python}
#df["Orf virus"]["C661MAA"]
df.iloc[1:10,1:10]
```



```{python}
import seaborn as sns

group = df.pop("group")
group
```

```{python}
df.shape
```

```{python}
df=df.loc[:,df.columns[df.max()>10]]
df.shape
```

```{python}
lut = dict(zip(group.unique(), "rbg"))
lut
```

```{python}
col_colors = group.map(lut)
col_colors
```


```{python}
# Create a legend
legend_labels = group.unique()
legend_labels
```

```{python}
#legend_handles = [plt.Rectangle((0, 0), 1, 1, color=c) for c in sns.color_palette(n_colors=len(legend_labels))]
#legend_handles = [plt.Rectangle((0, 0), 1, 1, color=c) for c in sns.color_palette("rbg",n_colors=len(legend_labels))]
legend_handles = [plt.Rectangle((0, 0), 1, 1, color=c) for c in "rbg"]
legend_handles
```


```{python clustermap}
g = sns.clustermap(df.T,
	cmap="viridis_r",
	norm=plt.matplotlib.colors.LogNorm(),
	figsize=(20, 25),
	col_colors=col_colors,
	col_cluster=False,
	cbar_kws={
		'orientation': 'horizontal',
		'location': 'bottom'}
	)

# Get the colorbar axes
colorbar_ax = g.ax_col_colors.axes
colorbar_ax.legend(legend_handles, legend_labels, ncols=3, loc="lower center", bbox_to_anchor=(0.5, 1.0))


plt.subplots_adjust(top=0.99,bottom=0.1)	#, left=0.15) #	ORDER MATTERS

#plt.title(r.opt['species'], fontsize=20)

#g.fig.suptitle(r.opt['species'])
cbar_ax = g.ax_cbar
cbar_ax.set_position([0.20, 0.02, 0.65, 0.02]) # [left, bottom, width, height]

plt.show()
```



