#!/usr/bin/env Rscript

args <- commandArgs()
fname <- normalizePath(sub("--file=", "", args[grepl("--file=", args)]))
thisfile <- readLines(fname)
newfname <- paste0(tempdir(), "/", basename(fname))
writeLines(thisfile[-1:-which(thisfile == "q(\"no\")")], newfname)

args = commandArgs(trailingOnly=TRUE)
#print(normalizePath(args[1]))

args[1] = normalizePath(args[1])

#output_file = paste(basename(fname),basename(args[1]),"html", sep=".")
#output_file = paste(normalizePath(args[1]),"html", sep=".")
output_file = paste(args[1],"html", sep=".")
print(output_file)

#rmarkdown::render(newfname, output_dir = dirname(fname), output_file = output_file )
rmarkdown::render(newfname, output_dir = dirname(output_file), output_file = output_file )
q("no")



---
title: "TEProf2_Heatmaps"
author: "Geno Guerra"
date: "2023-11-23"
output: html_document
---


```{r args}
args
```

```{r args1}
args[1]
```


```{r setup, include=FALSE}
# Process the data 

#datafile = "/Users/gguerra/Library/CloudStorage/Box-Box/Francis _Lab_Share/TEProf2/S1_S10_S2_ProteinSequences_fragments_in_Human_herpes_proteins.blastp.e0.05.csv"
#datafile = normalizePath(args[1])

datafile = args[1]


# Read in the datafile

df = read.csv(datafile, header=TRUE, sep = ",")


```

```{r functions, echo = FALSE}
quantile_breaks <- function(xs, n) {
  breaks <- quantile(as.matrix(xs), probs = seq(0, 1, length.out = n))
  breaks[!duplicated(breaks)]
}



```


Make sure install.packages("pheatmap") is run to install the necessary package. 

```{r heatmap setup, echo = FALSE, warning=FALSE}
library(RColorBrewer)
library(pheatmap)  # RUN 

df0 =df#[which(df$GTEx_Total_without_Testis ==0),]
  uv=unique(df0$virus)
gaps =c()
# Need to reorder the data so that it is collected by group
ordered= c()
for(k in c(1:length(uv))){
  ordered = c(ordered,which(df0$virus ==uv[k]) )
  if(k!=length(uv)){
  gaps=c(gaps,length(ordered))
  }
}
df1 = df0[as.integer(ordered),]
row_groups = df1$virus
mat_row = data.frame(group=row_groups)
rownames(mat_row)= df1$protein
df2=(df1[,-c(1:2)])
row.names(df2)= df1$protein




#	mat_colors <- list(group = brewer.pal(length(unique(row_groups)), "Set3"))
mat_colors <- list(group = rainbow(length(unique(row_groups))))
names(mat_colors$group) <- unique(row_groups)




mgaps = c(0, gaps, nrow(df2))

#TCGA tumors only --------------------------
#df3 = df2[, grep("_tumor", colnames(df3))]
df3 = df2[, grep("_tumor", colnames(df2))]
# -------------------------------------------

# Reorder rows so they are clustered within group. 
row.order = c()
#for(i in c(1:(length(mgaps)-1))){
#	row.order = c(row.order, hclust(dist(df3[c((mgaps[i]+1):(mgaps[i+1])),]))$order + mgaps[i] )
#}


for(i in c(1:(length(mgaps)-1))){
	if(mgaps[i+1]- mgaps[i] < 2){
		row.order = c(row.order,c((mgaps[i]+1):(mgaps[i+1])))
	}else{
		row.order = c(row.order, hclust(dist(df3[c((mgaps[i]+1):(mgaps[i+1])),]))$order + mgaps[i] )
	}
}



df4 = df3[row.order,]

#df4= df3[, grep("_normal", colnames(df3))]

dfb = as.matrix(df4)
mat_breaks <- quantile_breaks(df4, 100)

# Alternative approach 
dfb=unlist(df4)
dfb=dfb[which(dfb >0)]
mat_breaks = seq(min(dfb), max(dfb), ceiling((max(dfb)-min(dfb))/10))
mat_breaks = c(0, mat_breaks)
colorpal = c("lightyellow", colorRampPalette(c("orange", "red", "darkred", "black"))(length(mat_breaks)-1))

#pheat.plot=pheatmap(df4,
#	cluster_rows = F,
#	cluster_cols = T,
#	annotation_row = mat_row,
#	col=colorpal,
#	show_colnames = TRUE , 
#	show_rownames = TRUE,
#	gaps_row =gaps, 
#	main = "", 
#	breaks=mat_breaks)
##	annotation_colors =mat_colors, 


pheat.plot=pheatmap(df4,
	cluster_rows = F,
	cluster_cols = T,
	annotation_row = mat_row,
	col=colorpal,
	show_colnames = TRUE,
	show_rownames = TRUE,
	gaps_row = gaps,
	annotation_colors = mat_colors,
	main = "",
	breaks = mat_breaks,
	fontsize_row = 4,
	fontsize_col=7)

save_pheatmap_pdf <- function(z, filename, width, height) {
  stopifnot(!missing(z))
  stopifnot(!missing(filename))
  pdf(filename, width=width, height=height)
  grid::grid.newpage()
  grid::grid.draw(z$gtable)
  dev.off()
}
save_pheatmap_pdf(pheat.plot, paste(normalizePath(args[1]),"pdf", sep="."), 8, nrow(df4)/10)
  
```

